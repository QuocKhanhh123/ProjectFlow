{% extends "dashboard/base.html" %}

{% block include_header %}
<link rel="stylesheet" href="/static/dashboard/project.css">
{% endblock %}

{% block container %}
<div class="project-detail-container">
  <div class="project-header">
    <div class="project-info">
      <h1 class="project-title">{{ project.name }}</h1>
      <div class="project-desc">{{ project.description }}</div>
    </div>
    <div class="project-actions">
      {% if can_edit %}
        <button class="btn btn-edit" onclick="showEditProjectModal()">‚úèÔ∏è Ch·ªânh s·ª≠a d·ª± √°n</button>
        <button class="btn btn-delete" onclick="showDeleteProjectModal()">üóëÔ∏è</button>
      {% endif %}
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('tasks')">C√¥ng vi·ªác</div>
    <div class="tab" onclick="showTab('members')">Th√†nh vi√™n</div>
  </div>

  <div class="tab-content" id="tasks-tab">
    <div class="task-header">
      <button class="btn btn-add-task" onclick="showCreateTaskModal()">+ T·∫°o c√¥ng vi·ªác</button>
    </div>
    
    <div class="task-columns">
      <div class="task-column">
        <div class="column-header">
          <h3>C·∫ßn l√†m</h3>
          <span class="task-count">{{ todo_count }}</span>
        </div>
        <div class="column-content" id="todo-column">
          {% for task in tasks %}
            {% if task.status == 'TODO' %}
              <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <span class="task-priority priority-{{ task.priority|lower }}">
                    {% if task.priority == 'HIGH' %}Cao{% elif task.priority == 'MEDIUM' %}Trung b√¨nh{% else %}Th·∫•p{% endif %}
                  </span>
                </div>
                {% if task.description %}
                  <p class="task-description">{{ task.description|truncatewords:20 }}</p>
                {% endif %}
                <div class="task-footer">
                  <div class="task-assignee">
                    {% if task.assignee %}
                      <span class="assignee-name">{{ task.assignee.username }}</span>
                    {% else %}
                      <span class="assignee-name">Ch∆∞a g√°n</span>
                    {% endif %}
                  </div>
                  <div class="task-date">{{ task.created_at|date:"d/m/Y" }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</div>
          {% endfor %}
        </div>
      </div>
      
      <div class="task-column">
        <div class="column-header">
          <h3>ƒêang th·ª±c hi·ªán</h3>
          <span class="task-count">{{ in_progress_count }}</span>
        </div>
        <div class="column-content" id="in-progress-column">
          {% for task in tasks %}
            {% if task.status == 'IN_PROGRESS' %}
              <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <span class="task-priority priority-{{ task.priority|lower }}">
                    {% if task.priority == 'HIGH' %}Cao{% elif task.priority == 'MEDIUM' %}Trung b√¨nh{% else %}Th·∫•p{% endif %}
                  </span>
                </div>
                {% if task.description %}
                  <p class="task-description">{{ task.description|truncatewords:20 }}</p>
                {% endif %}
                <div class="task-footer">
                  <div class="task-assignee">
                    {% if task.assignee %}
                      <span class="assignee-name">{{ task.assignee.username }}</span>
                    {% else %}
                      <span class="assignee-name">Ch∆∞a g√°n</span>
                    {% endif %}
                  </div>
                  <div class="task-date">{{ task.created_at|date:"d/m/Y" }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</div>
          {% endfor %}
        </div>
      </div>
      
      <div class="task-column">
        <div class="column-header">
          <h3>Ho√†n th√†nh</h3>
          <span class="task-count">{{ done_count }}</span>
        </div>
        <div class="column-content" id="done-column">
          {% for task in tasks %}
            {% if task.status == 'DONE' %}
              <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <span class="task-priority priority-{{ task.priority|lower }}">
                    {% if task.priority == 'HIGH' %}Cao{% elif task.priority == 'MEDIUM' %}Trung b√¨nh{% else %}Th·∫•p{% endif %}
                  </span>
                </div>
                {% if task.description %}
                  <p class="task-description">{{ task.description|truncatewords:20 }}</p>
                {% endif %}
                <div class="task-footer">
                  <div class="task-assignee">
                    {% if task.assignee %}
                      <span class="assignee-name">{{ task.assignee.username }}</span>
                    {% else %}
                      <span class="assignee-name">Ch∆∞a g√°n</span>
                    {% endif %}
                  </div>
                  <div class="task-date">{{ task.created_at|date:"d/m/Y" }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content hidden" id="members-tab">
    <div class="member-header">
      <input class="member-search" placeholder="T√¨m ki·∫øm th√†nh vi√™n...">
      {% if can_edit %}
        <button class="btn-add-member" onclick="showAddMemberModal()">üë§+ Th√™m th√†nh vi√™n</button>
      {% endif %}
    </div>

    <div class="member-list">
      <h3>Th√†nh vi√™n d·ª± √°n ({{ members|length }})</h3>
      <div id="membersList">
        {% for member in members %}
          <div class="member-item" data-member-id="{{ member.id }}">
            <div class="avatar"></div>
            <div class="member-info">
              <div>
                <strong>{{ member.user.username }}</strong>
                <span class="role-badge">
                  {% if member.role == 'OWNER' %}Ch·ªß s·ªü h·ªØu{% elif member.role == 'ADMIN' %}Qu·∫£n tr·ªã vi√™n{% else %}Th√†nh vi√™n{% endif %}
                </span>
              </div>
              <div class="email">{{ member.user.email }}</div>
              <div class="joined-date">Tham gia: {{ member.joined_at|date:"d/m/Y" }}</div>
            </div>
            {% if can_edit and member.role != 'OWNER' %}
              <div class="member-actions">
                <button class="btn btn-sm btn-outline" data-member-id="{{ member.id }}" data-role="{{ member.role }}" onclick="updateMemberRole('{{ member.id }}', '{{ member.role }}')">ƒê·ªïi vai tr√≤</button>
                <button class="btn btn-sm btn-danger" data-member-id="{{ member.id }}" data-username="{{ member.user.username }}" onclick="removeMember('{{ member.id }}', '{{ member.user.username }}')">X√≥a</button>
              </div>
            {% endif %}
          </div>
        {% empty %}
          <div class="no-members">Kh√¥ng c√≥ th√†nh vi√™n n√†o</div>
        {% endfor %}
      </div>
    </div>
  </div>
  
  <!-- Modal T·∫°o c√¥ng vi·ªác -->
  <div id="createTaskModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>T·∫°o c√¥ng vi·ªác m·ªõi</h2>
        <button class="modal-close" onclick="hideCreateTaskModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">ƒêi·ªÅn th√¥ng tin ƒë·ªÉ t·∫°o c√¥ng vi·ªác m·ªõi.</p>
        
        <form id="createTaskForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="taskTitle">Ti√™u ƒë·ªÅ</label>
            <input type="text" id="taskTitle" name="taskTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác" required>
          </div>
          
          <div class="form-group">
            <label for="taskDescription">M√¥ t·∫£</label>
            <textarea id="taskDescription" name="taskDescription" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác" rows="4"></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="taskStatus">Tr·∫°ng th√°i</label>
              <select id="taskStatus" name="taskStatus">
                <option value="TODO">C·∫ßn l√†m</option>
                <option value="IN_PROGRESS">ƒêang th·ª±c hi·ªán</option>
                <option value="DONE">Ho√†n th√†nh</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="taskPriority">ƒê·ªô ∆∞u ti√™n</label>
              <select id="taskPriority" name="taskPriority">
                <option value="LOW">Th·∫•p</option>
                <option value="MEDIUM">Trung b√¨nh</option>
                <option value="HIGH">Cao</option>
              </select>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="hideCreateTaskModal()">H·ªßy</button>
            <button type="submit" class="btn btn-create">T·∫°o c√¥ng vi·ªác</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Ch·ªânh s·ª≠a d·ª± √°n -->
  <div id="editProjectModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ch·ªânh s·ª≠a d·ª± √°n</h2>
        <button class="modal-close" onclick="hideEditProjectModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="editProjectForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="projectName">T√™n d·ª± √°n</label>
            <input type="text" id="projectName" name="name" value="{{ project.name }}" required>
          </div>
          
          <div class="form-group">
            <label for="projectDescription">M√¥ t·∫£</label>
            <textarea id="projectDescription" name="description" rows="4" required>{{ project.description }}</textarea>
          </div>
          
          <div class="form-group">
            <label for="projectStatus">Tr·∫°ng th√°i</label>
            <select id="projectStatus" name="status">
              <option value="ACTIVE" {% if project.status == 'ACTIVE' %}selected{% endif %}>ƒêang ho·∫°t ƒë·ªông</option>
              <option value="COMPLETED" {% if project.status == 'COMPLETED' %}selected{% endif %}>Ho√†n th√†nh</option>
              <option value="ON_HOLD" {% if project.status == 'ON_HOLD' %}selected{% endif %}>T·∫°m d·ª´ng</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="hideEditProjectModal()">H·ªßy</button>
            <button type="submit" class="btn btn-create">L∆∞u thay ƒë·ªïi</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal X√≥a d·ª± √°n -->
  <div id="deleteProjectModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>X√°c nh·∫≠n x√≥a d·ª± √°n</h2>
        <button class="modal-close" onclick="hideDeleteProjectModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d·ª± √°n <strong>"{{ project.name }}"</strong>?</p>
        <p style="color: #ef4444; font-size: 0.9rem;">‚ö†Ô∏è H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. T·∫•t c·∫£ c√¥ng vi·ªác v√† d·ªØ li·ªáu li√™n quan s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.</p>
        
        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="hideDeleteProjectModal()">H·ªßy</button>
          <button type="button" class="btn btn-delete" onclick="confirmDeleteProject()">X√≥a d·ª± √°n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Th√™m th√†nh vi√™n -->
  <div id="addMemberModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Th√™m th√†nh vi√™n</h2>
        <button class="modal-close" onclick="hideAddMemberModal()">√ó</button>
      </div>
      <div class="modal-body">
        <form id="addMemberForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="memberEmail">Email th√†nh vi√™n</label>
            <input type="email" id="memberEmail" name="email" placeholder="Nh·∫≠p email c·ªßa th√†nh vi√™n" required>
          </div>
          
          <div class="form-group">
            <label for="memberRole">Vai tr√≤</label>
            <select id="memberRole" name="role">
              <option value="MEMBER">Th√†nh vi√™n</option>
              <option value="ADMIN">Qu·∫£n tr·ªã vi√™n</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="hideAddMemberModal()">H·ªßy</button>
            <button type="submit" class="btn btn-create">Th√™m th√†nh vi√™n</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal ƒê·ªïi vai tr√≤ -->
  <div id="changeRoleModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ƒê·ªïi vai tr√≤ th√†nh vi√™n</h2>
        <button class="modal-close" onclick="hideChangeRoleModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">B·∫°n mu·ªën thay ƒë·ªïi vai tr√≤ c·ªßa <strong id="roleMemberName"></strong>?</p>
        
        <form id="changeRoleForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="newRole">Vai tr√≤ m·ªõi</label>
            <select id="newRole" name="role">
              <option value="MEMBER">Th√†nh vi√™n</option>
              <option value="ADMIN">Qu·∫£n tr·ªã vi√™n</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="hideChangeRoleModal()">H·ªßy</button>
            <button type="submit" class="btn btn-create">C·∫≠p nh·∫≠t vai tr√≤</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal X√≥a th√†nh vi√™n -->
  <div id="removeMemberModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>X√°c nh·∫≠n x√≥a th√†nh vi√™n</h2>
        <button class="modal-close" onclick="hideRemoveMemberModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a th√†nh vi√™n <strong id="removeMemberName"></strong> kh·ªèi d·ª± √°n?</p>
        <p style="color: #ef4444; font-size: 0.9rem; margin-top: 12px;">
          ‚ö†Ô∏è Th√†nh vi√™n s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p v√†o d·ª± √°n v√† kh√¥ng th·ªÉ xem c√°c c√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c giao.
        </p>
        
        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="hideRemoveMemberModal()">H·ªßy</button>
          <button type="button" class="btn btn-delete" onclick="confirmRemoveMember()">X√≥a th√†nh vi√™n</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    function showTab(tab) {
      const taskTab = document.getElementById('tasks-tab');
      const memberTab = document.getElementById('members-tab');
      const tabs = document.querySelectorAll('.tab');

      tabs.forEach(t => t.classList.remove('active'));

      if (tab === 'tasks') {
        taskTab.classList.remove('hidden');
        memberTab.classList.add('hidden');
        tabs[0].classList.add('active');
      } else if (tab === 'members') {
        taskTab.classList.add('hidden');
        memberTab.classList.remove('hidden');
        tabs[1].classList.add('active');
      }
    }

    // Task modal functions
    function showCreateTaskModal() {
      document.getElementById('createTaskModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function hideCreateTaskModal() {
      document.getElementById('createTaskModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('createTaskForm').reset();
    }

    // Project modal functions
    function showEditProjectModal() {
      document.getElementById('editProjectModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function hideEditProjectModal() {
      document.getElementById('editProjectModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    function showDeleteProjectModal() {
      document.getElementById('deleteProjectModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function hideDeleteProjectModal() {
      document.getElementById('deleteProjectModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Member modal functions
function showAddMemberModal() {
  document.getElementById('addMemberModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideAddMemberModal() {
  document.getElementById('addMemberModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
  document.getElementById('addMemberForm').reset();
}

// Change role modal functions
function showChangeRoleModal() {
  document.getElementById('changeRoleModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideChangeRoleModal() {
  document.getElementById('changeRoleModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
  document.getElementById('changeRoleForm').reset();
}

// Remove member modal functions
function showRemoveMemberModal() {
  document.getElementById('removeMemberModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideRemoveMemberModal() {
  document.getElementById('removeMemberModal').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
      const modals = ['createTaskModal', 'editProjectModal', 'deleteProjectModal', 'addMemberModal', 'changeRoleModal', 'removeMemberModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (e.target === modal) {
          modal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
      });
    });

    // Edit Project Form
    document.getElementById('editProjectForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const projectData = {
        name: formData.get('name'),
        description: formData.get('description'),
        status: formData.get('status')
      };
      
      fetch(`/dashboard/projects/{{ project.id }}/edit/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: new URLSearchParams(projectData)
      })
      .then(response => {
        if (response.ok) {
          // Success - update the page content
          hideEditProjectModal();
          showNotification('D·ª± √°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
          
          // Update project title and description on the page
          updateProjectDisplay(projectData);
        } else {
          return response.text().then(text => {
            showNotification('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ª± √°n', 'error');
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ª± √°n', 'error');
      });
    });

    // Delete Project
    function confirmDeleteProject() {
      fetch(`/dashboard/projects/{{ project.id }}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          return response.text();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a d·ª± √°n', 'error');
      });
    }

    // Add Member Form
    document.getElementById('addMemberForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const memberData = {
        email: formData.get('email'),
        role: formData.get('role')
      };
      
      fetch(`/dashboard/projects/{{ project.id }}/members/invite/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(memberData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          hideAddMemberModal();
          showNotification(data.message, 'success');
          // Add member to the list
          addMemberToList(data.member);
        } else {
          showNotification(data.error || 'C√≥ l·ªói x·∫£y ra khi th√™m th√†nh vi√™n', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi th√™m th√†nh vi√™n', 'error');
      });
    });

    // Change Role Form
    document.getElementById('changeRoleForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (!currentMemberId) {
        showNotification('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t vai tr√≤', 'error');
        return;
      }
      
      const formData = new FormData(this);
      const newRole = formData.get('role');
      const roleText = newRole === 'ADMIN' ? 'Qu·∫£n tr·ªã vi√™n' : 'Th√†nh vi√™n';
      
      fetch(`/dashboard/projects/{{ project.id }}/members/${currentMemberId}/update-role/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ role: newRole })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          hideChangeRoleModal();
          showNotification(data.message, 'success');
          
          // Update role badge
          const memberItem = document.querySelector(`[data-member-id="${currentMemberId}"]`);
          if (memberItem) {
            const roleBadge = memberItem.querySelector('.role-badge');
            roleBadge.textContent = roleText;
            
            // Update button
            const roleButton = memberItem.querySelector('.btn-outline');
            roleButton.setAttribute('onclick', `updateMemberRole('${currentMemberId}', '${newRole}')`);
          }
          
          // Reset variables
          currentMemberId = null;
          currentMemberName = null;
        } else {
          showNotification(data.error || 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t vai tr√≤', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t vai tr√≤', 'error');
      });
    });

    // Remove Member
    let currentRemoveMemberId = null;
    let currentRemoveMemberName = null;
    
    function removeMember(memberId, username) {
      currentRemoveMemberId = memberId;
      currentRemoveMemberName = username;
      
      // Set member name in modal
      document.getElementById('removeMemberName').textContent = username;
      
      // Show modal
      showRemoveMemberModal();
    }
    
    function confirmRemoveMember() {
      if (!currentRemoveMemberId) {
        showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a th√†nh vi√™n', 'error');
        return;
      }
      
      fetch(`/dashboard/projects/{{ project.id }}/members/${currentRemoveMemberId}/remove/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          hideRemoveMemberModal();
          showNotification(data.message, 'success');
          // Remove member from the list
          const memberItem = document.querySelector(`[data-member-id="${currentRemoveMemberId}"]`);
          if (memberItem) {
            memberItem.remove();
          }
          updateMemberCount();
          
          // Reset variables
          currentRemoveMemberId = null;
          currentRemoveMemberName = null;
        } else {
          showNotification(data.error || 'C√≥ l·ªói x·∫£y ra khi x√≥a th√†nh vi√™n', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi x√≥a th√†nh vi√™n', 'error');
      });
    }

            // Update Member Role
        let currentMemberId = null;
        let currentMemberName = null;
        
        function updateMemberRole(memberId, currentRole) {
          currentMemberId = memberId;
          
          // Get member name from DOM
          const memberItem = document.querySelector(`[data-member-id="${memberId}"]`);
          currentMemberName = memberItem ? memberItem.querySelector('strong').textContent : 'th√†nh vi√™n';
          
          // Set member name in modal
          document.getElementById('roleMemberName').textContent = currentMemberName;
          
          // Set current role as opposite in select
          const newRoleSelect = document.getElementById('newRole');
          const newRole = currentRole === 'ADMIN' ? 'MEMBER' : 'ADMIN';
          newRoleSelect.value = newRole;
          
          // Show modal
          showChangeRoleModal();
        }

    // Helper functions
    function updateProjectDisplay(projectData) {
      // Update project title
      const projectTitle = document.querySelector('.project-title');
      if (projectTitle) {
        projectTitle.textContent = projectData.name;
      }
      
      // Update project description
      const projectDesc = document.querySelector('.project-desc');
      if (projectDesc) {
        projectDesc.textContent = projectData.description;
      }
      
      // Update page title
      document.title = `${projectData.name} - TaskFlow`;
    }

    function addMemberToList(member) {
      const membersList = document.getElementById('membersList');
      const noMembers = membersList.querySelector('.no-members');
      
      if (noMembers) {
        noMembers.remove();
      }
      
      const memberItem = document.createElement('div');
      memberItem.className = 'member-item';
      memberItem.setAttribute('data-member-id', member.id);
      
      const joinedDate = new Date(member.joined_at).toLocaleDateString('vi-VN');
      const roleText = member.role === 'ADMIN' ? 'Qu·∫£n tr·ªã vi√™n' : 'Th√†nh vi√™n';
      
              memberItem.innerHTML = `
          <div class="avatar"></div>
          <div class="member-info">
            <div>
              <strong>${member.username}</strong>
              <span class="role-badge">${roleText}</span>
            </div>
            <div class="email">${member.email}</div>
            <div class="joined-date">Tham gia: ${joinedDate}</div>
          </div>
          <div class="member-actions">
            <button class="btn btn-sm btn-outline" onclick="updateMemberRole('${member.id}', '${member.role}')">ƒê·ªïi vai tr√≤</button>
            <button class="btn btn-sm btn-danger" onclick="removeMember('${member.id}', '${member.username}')">X√≥a</button>
          </div>
        `;
      
      membersList.appendChild(memberItem);
      updateMemberCount();
    }

    function updateMemberCount() {
      const memberCount = document.querySelectorAll('#membersList .member-item').length;
      const memberCountEl = document.querySelector('.member-list h3');
      if (memberCountEl) {
        memberCountEl.textContent = `Th√†nh vi√™n d·ª± √°n (${memberCount})`;
      }
    }

    // Task creation form (existing code)
    document.getElementById('createTaskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const taskData = {
        title: formData.get('taskTitle'),
        description: formData.get('taskDescription'),
        status: formData.get('taskStatus'),
        priority: formData.get('taskPriority')
      };
      
      fetch(`/dashboard/projects/{{ project.id }}/tasks/create/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(taskData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          hideCreateTaskModal();
          showNotification('C√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');
          addTaskToColumn(data.task);
          updateTaskCounts();
        } else {
          showNotification(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫°o c√¥ng vi·ªác', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi t·∫°o c√¥ng vi·ªác', 'error');
      });
    });

    // Function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Function to add task to appropriate column
    function addTaskToColumn(task) {
      const columnMap = {
        'TODO': 'todo-column',
        'IN_PROGRESS': 'in-progress-column',
        'DONE': 'done-column'
      };
      
      const priorityMap = {
        'HIGH': 'Cao',
        'MEDIUM': 'Trung b√¨nh',
        'LOW': 'Th·∫•p'
      };
      
      const columnId = columnMap[task.status];
      const column = document.getElementById(columnId);
      
      if (column) {
        const noTasksMsg = column.querySelector('.no-tasks');
        if (noTasksMsg) {
          noTasksMsg.remove();
        }
        
        const taskCard = document.createElement('div');
        taskCard.className = 'task-card';
        taskCard.setAttribute('data-task-id', task.id);
        
        const taskDate = new Date(task.created_at).toLocaleDateString('vi-VN');
        
        taskCard.innerHTML = `
          <div class="task-header">
            <h4 class="task-title">${task.title}</h4>
            <span class="task-priority priority-${task.priority.toLowerCase()}">
              ${priorityMap[task.priority]}
            </span>
          </div>
          ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
          <div class="task-footer">
            <div class="task-assignee">
              <span class="assignee-name">${task.assignee || 'Ch∆∞a g√°n'}</span>
            </div>
            <div class="task-date">${taskDate}</div>
          </div>
        `;
        
        column.appendChild(taskCard);
        
        // Add click event to new task card
        taskCard.addEventListener('click', function() {
          const taskId = this.getAttribute('data-task-id');
          if (taskId) {
            window.location.href = `/dashboard/projects/{{ project.id }}/tasks/${taskId}/`;
          }
        });
      }
    }

    // Function to update task counts
    function updateTaskCounts() {
      const todoCount = document.querySelectorAll('#todo-column .task-card').length;
      const inProgressCount = document.querySelectorAll('#in-progress-column .task-card').length;
      const doneCount = document.querySelectorAll('#done-column .task-card').length;
      
      const todoCountEl = document.querySelector('.task-column:nth-child(1) .task-count');
      const inProgressCountEl = document.querySelector('.task-column:nth-child(2) .task-count');
      const doneCountEl = document.querySelector('.task-column:nth-child(3) .task-count');
      
      if (todoCountEl) todoCountEl.textContent = todoCount;
      if (inProgressCountEl) inProgressCountEl.textContent = inProgressCount;
      if (doneCountEl) doneCountEl.textContent = doneCount;
    }

    // Add click event listeners to task cards
    document.addEventListener('DOMContentLoaded', function() {
      const taskCards = document.querySelectorAll('.task-card');
      taskCards.forEach(card => {
        card.addEventListener('click', function() {
          const taskId = this.getAttribute('data-task-id');
          if (taskId) {
            window.location.href = `/dashboard/projects/{{ project.id }}/tasks/${taskId}/`;
          }
        });
      });
    });

    // Function to show notification
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        ${type === 'success' ? 'background: #059669;' : 'background: #dc2626;'}
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Add CSS for notification animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      .member-actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
      }
      
      .member-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid #374151;
      }
      
      .btn-sm {
        padding: 4px 8px;
        font-size: 0.75rem;
      }
      
      .btn-outline {
        background: transparent;
        border: 1px solid #3b82f6;
        color: #3b82f6;
      }
      
      .btn-outline:hover {
        background: #3b82f6;
        color: white;
      }
      
      .btn-danger {
        background: #ef4444;
        color: white;
        border: 1px solid #ef4444;
      }
      
      .btn-danger:hover {
        background: #dc2626;
      }
    `;
    document.head.appendChild(style);
  </script>


{% endblock %}