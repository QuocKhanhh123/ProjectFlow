{% extends "dashboard/base.html" %}

{% block include_header %}
<link rel="stylesheet" href="/static/dashboard/project.css">
{% endblock %}

{% block container %}
<div class="project-detail-container">
  <div class="project-header">
    <div class="project-info">
      <h1 class="project-title">{{ project.name }}</h1>
      <div class="project-desc">{{ project.description }}</div>
    </div>
    <div class="project-actions">
      {% if can_edit %}
        <button class="btn btn-edit">‚úèÔ∏è Ch·ªânh s·ª≠a d·ª± √°n</button>
        <button class="btn btn-delete">üóëÔ∏è</button>
      {% endif %}
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('tasks')">C√¥ng vi·ªác</div>
    <div class="tab" onclick="showTab('members')">Th√†nh vi√™n</div>
  </div>

  <div class="tab-content" id="tasks-tab">
    <div class="task-header">
      <button class="btn btn-add-task" onclick="showCreateTaskModal()">+ T·∫°o c√¥ng vi·ªác</button>
    </div>
    
    <div class="task-columns">
      <div class="task-column">
        <div class="column-header">
          <h3>C·∫ßn l√†m</h3>
          <span class="task-count">{{ todo_count }}</span>
        </div>
        <div class="column-content" id="todo-column">
          {% for task in tasks %}
            {% if task.status == 'TODO' %}
              <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <span class="task-priority priority-{{ task.priority|lower }}">
                    {% if task.priority == 'HIGH' %}Cao{% elif task.priority == 'MEDIUM' %}Trung b√¨nh{% else %}Th·∫•p{% endif %}
                  </span>
                </div>
                {% if task.description %}
                  <p class="task-description">{{ task.description|truncatewords:20 }}</p>
                {% endif %}
                <div class="task-footer">
                  <div class="task-assignee">
                    {% if task.assignee %}
                      <span class="assignee-name">{{ task.assignee.username }}</span>
                    {% else %}
                      <span class="assignee-name">Ch∆∞a g√°n</span>
                    {% endif %}
                  </div>
                  <div class="task-date">{{ task.created_at|date:"d/m/Y" }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</div>
          {% endfor %}
        </div>
      </div>
      
      <div class="task-column">
        <div class="column-header">
          <h3>ƒêang th·ª±c hi·ªán</h3>
          <span class="task-count">{{ in_progress_count }}</span>
        </div>
        <div class="column-content" id="in-progress-column">
          {% for task in tasks %}
            {% if task.status == 'IN_PROGRESS' %}
              <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <span class="task-priority priority-{{ task.priority|lower }}">
                    {% if task.priority == 'HIGH' %}Cao{% elif task.priority == 'MEDIUM' %}Trung b√¨nh{% else %}Th·∫•p{% endif %}
                  </span>
                </div>
                {% if task.description %}
                  <p class="task-description">{{ task.description|truncatewords:20 }}</p>
                {% endif %}
                <div class="task-footer">
                  <div class="task-assignee">
                    {% if task.assignee %}
                      <span class="assignee-name">{{ task.assignee.username }}</span>
                    {% else %}
                      <span class="assignee-name">Ch∆∞a g√°n</span>
                    {% endif %}
                  </div>
                  <div class="task-date">{{ task.created_at|date:"d/m/Y" }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</div>
          {% endfor %}
        </div>
      </div>
      
      <div class="task-column">
        <div class="column-header">
          <h3>Ho√†n th√†nh</h3>
          <span class="task-count">{{ done_count }}</span>
        </div>
        <div class="column-content" id="done-column">
          {% for task in tasks %}
            {% if task.status == 'DONE' %}
              <div class="task-card" data-task-id="{{ task.id }}">
                <div class="task-header">
                  <h4 class="task-title">{{ task.title }}</h4>
                  <span class="task-priority priority-{{ task.priority|lower }}">
                    {% if task.priority == 'HIGH' %}Cao{% elif task.priority == 'MEDIUM' %}Trung b√¨nh{% else %}Th·∫•p{% endif %}
                  </span>
                </div>
                {% if task.description %}
                  <p class="task-description">{{ task.description|truncatewords:20 }}</p>
                {% endif %}
                <div class="task-footer">
                  <div class="task-assignee">
                    {% if task.assignee %}
                      <span class="assignee-name">{{ task.assignee.username }}</span>
                    {% else %}
                      <span class="assignee-name">Ch∆∞a g√°n</span>
                    {% endif %}
                  </div>
                  <div class="task-date">{{ task.created_at|date:"d/m/Y" }}</div>
                </div>
              </div>
            {% endif %}
          {% empty %}
            <div class="no-tasks">Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content hidden" id="members-tab">
    <div class="member-header">
      <input class="member-search" placeholder="T√¨m ki·∫øm th√†nh vi√™n...">
      {% if can_edit %}
        <button class="btn-add-member">üë§+ Th√™m th√†nh vi√™n</button>
      {% endif %}
    </div>

    <div class="member-list">
      <h3>Th√†nh vi√™n d·ª± √°n ({{ members|length }})</h3>
      {% for member in members %}
        <div class="member-item">
          <div class="avatar"></div>
          <div class="member-info">
            <div>
              <strong>{{ member.user.username }}</strong>
              <span class="role-badge">
                {% if member.role == 'OWNER' %}Ch·ªß s·ªü h·ªØu{% elif member.role == 'ADMIN' %}Qu·∫£n tr·ªã vi√™n{% else %}Th√†nh vi√™n{% endif %}
              </span>
            </div>
            <div class="email">{{ member.user.email }}</div>
            <div class="joined-date">Tham gia: {{ member.joined_at|date:"d/m/Y" }}</div>
          </div>
        </div>
      {% empty %}
        <div class="no-members">Kh√¥ng c√≥ th√†nh vi√™n n√†o</div>
      {% endfor %}
    </div>
  </div>
  
  <!-- Modal T·∫°o c√¥ng vi·ªác -->
  <div id="createTaskModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>T·∫°o c√¥ng vi·ªác m·ªõi</h2>
        <button class="modal-close" onclick="hideCreateTaskModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">ƒêi·ªÅn th√¥ng tin ƒë·ªÉ t·∫°o c√¥ng vi·ªác m·ªõi.</p>
        
        <form id="createTaskForm">
          {% csrf_token %}
          <div class="form-group">
            <label for="taskTitle">Ti√™u ƒë·ªÅ</label>
            <input type="text" id="taskTitle" name="taskTitle" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác" required>
          </div>
          
          <div class="form-group">
            <label for="taskDescription">M√¥ t·∫£</label>
            <textarea id="taskDescription" name="taskDescription" placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác" rows="4"></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="taskStatus">Tr·∫°ng th√°i</label>
              <select id="taskStatus" name="taskStatus">
                <option value="TODO">C·∫ßn l√†m</option>
                <option value="IN_PROGRESS">ƒêang th·ª±c hi·ªán</option>
                <option value="DONE">Ho√†n th√†nh</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="taskPriority">ƒê·ªô ∆∞u ti√™n</label>
              <select id="taskPriority" name="taskPriority">
                <option value="LOW">Th·∫•p</option>
                <option value="MEDIUM">Trung b√¨nh</option>
                <option value="HIGH">Cao</option>
              </select>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="hideCreateTaskModal()">H·ªßy</button>
            <button type="submit" class="btn btn-create">T·∫°o c√¥ng vi·ªác</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

  <script>
    function showTab(tab) {
      const taskTab = document.getElementById('tasks-tab');
      const memberTab = document.getElementById('members-tab');
      const tabs = document.querySelectorAll('.tab');

      tabs.forEach(t => t.classList.remove('active'));

      if (tab === 'tasks') {
        taskTab.classList.remove('hidden');
        memberTab.classList.add('hidden');
        tabs[0].classList.add('active');
      } else if (tab === 'members') {
        taskTab.classList.add('hidden');
        memberTab.classList.remove('hidden');
        tabs[1].classList.add('active');
      }
    }

    function showCreateTaskModal() {
      document.getElementById('createTaskModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function hideCreateTaskModal() {
      document.getElementById('createTaskModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('createTaskForm').reset();
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('createTaskModal');
      if (e.target === modal) {
        hideCreateTaskModal();
      }
    });

    // X·ª≠ l√Ω form submit
    document.getElementById('createTaskForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const taskData = {
        title: formData.get('taskTitle'),
        description: formData.get('taskDescription'),
        status: formData.get('taskStatus'),
        priority: formData.get('taskPriority')
      };
      
      // Send POST request to create task
      fetch(`/dashboard/projects/{{ project.id }}/tasks/create/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(taskData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Task created successfully
          console.log('Task created:', data.task);
          hideCreateTaskModal();
          
          // Show success message
          showNotification('C√¥ng vi·ªác ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!', 'success');
          
          // Add task to the appropriate column
          addTaskToColumn(data.task);
          
          // Update task counts
          updateTaskCounts();
        } else {
          // Handle error
          showNotification(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫°o c√¥ng vi·ªác', 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showNotification('C√≥ l·ªói x·∫£y ra khi t·∫°o c√¥ng vi·ªác', 'error');
      });
    });

    // Function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Function to add task to appropriate column
    function addTaskToColumn(task) {
      const columnMap = {
        'TODO': 'todo-column',
        'IN_PROGRESS': 'in-progress-column',
        'DONE': 'done-column'
      };
      
      const priorityMap = {
        'HIGH': 'Cao',
        'MEDIUM': 'Trung b√¨nh',
        'LOW': 'Th·∫•p'
      };
      
      const columnId = columnMap[task.status];
      const column = document.getElementById(columnId);
      
      if (column) {
        // Remove "no tasks" message if it exists
        const noTasksMsg = column.querySelector('.no-tasks');
        if (noTasksMsg) {
          noTasksMsg.remove();
        }
        
        // Create task card HTML
        const taskCard = document.createElement('div');
        taskCard.className = 'task-card';
        taskCard.setAttribute('data-task-id', task.id);
        
        const taskDate = new Date(task.created_at).toLocaleDateString('vi-VN');
        
        taskCard.innerHTML = `
          <div class="task-header">
            <h4 class="task-title">${task.title}</h4>
            <span class="task-priority priority-${task.priority.toLowerCase()}">
              ${priorityMap[task.priority]}
            </span>
          </div>
          ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
          <div class="task-footer">
            <div class="task-assignee">
              <span class="assignee-name">${task.assignee || 'Ch∆∞a g√°n'}</span>
            </div>
            <div class="task-date">${taskDate}</div>
          </div>
        `;
        
        // Add task card to column
        column.appendChild(taskCard);
      }
    }

    // Function to update task counts
    function updateTaskCounts() {
      const todoCount = document.querySelectorAll('#todo-column .task-card').length;
      const inProgressCount = document.querySelectorAll('#in-progress-column .task-card').length;
      const doneCount = document.querySelectorAll('#done-column .task-card').length;
      
      // Update count displays
      const todoCountEl = document.querySelector('.task-column:nth-child(1) .task-count');
      const inProgressCountEl = document.querySelector('.task-column:nth-child(2) .task-count');
      const doneCountEl = document.querySelector('.task-column:nth-child(3) .task-count');
      
      if (todoCountEl) todoCountEl.textContent = todoCount;
      if (inProgressCountEl) inProgressCountEl.textContent = inProgressCount;
      if (doneCountEl) doneCountEl.textContent = doneCount;
    }

    // Add click event listeners to task cards
    document.addEventListener('DOMContentLoaded', function() {
      const taskCards = document.querySelectorAll('.task-card');
      taskCards.forEach(card => {
        card.addEventListener('click', function() {
          const taskId = this.getAttribute('data-task-id');
          if (taskId) {
            window.location.href = `/dashboard/projects/{{ project.id }}/tasks/${taskId}/`;
          }
        });
      });
    });

    // Function to show notification
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        ${type === 'success' ? 'background: #059669;' : 'background: #dc2626;'}
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Add CSS for notification animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
  </script>


{% endblock %}